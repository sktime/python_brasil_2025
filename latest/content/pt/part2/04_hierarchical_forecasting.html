<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>9&nbsp; Forecasting Hierárquico – Previsão de Séries temporais com Python: um pequeno guia</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../content/pt/part2/05_deep_learning.html" rel="next">
<link href="../../../content/pt/part2/03_panel_data.html" rel="prev">
<link href="../../../logo.jpeg" rel="icon" type="image/jpeg">
<script src="../../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap-0dd2bd5de344125cf763a379ddc3eb04.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="../../../site_libs/quarto-diagram/mermaid.min.js"></script>
<script src="../../../site_libs/quarto-diagram/mermaid-init.js"></script>
<link href="../../../site_libs/quarto-diagram/mermaid.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../../content/pt/part2/01_exog_variables.html">Part II: Intermediário</a></li><li class="breadcrumb-item"><a href="../../../content/pt/part2/04_hierarchical_forecasting.html"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Forecasting Hierárquico</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="../../../index.html" class="sidebar-logo-link">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="../../../">Previsão de Séries temporais com Python: um pequeno guia</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/sktime/python_brasil_2025/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" role="link" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=|url|">
              <i class="bi bi-twitter pe-1"></i>
            Twitter
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=|url|">
              <i class="bi bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
      </ul>
    </div>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Prefácio</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Part I: Básico</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/pt/part1/00_intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Definição do problema</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/pt/part1/01_naive.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Primeiro passos com sktime e modelo Naive</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/pt/part1/02_components_and_diff.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Decomposição de séries temporais e modelos clássicos</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/pt/part1/03_ets_and_ar.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Modelos estatísticos clássicos e diferenciação</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/pt/part1/04_metricas.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Métricas e cross-validation</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Part II: Intermediário</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/pt/part2/01_exog_variables.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Variáveis Exógenas</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/pt/part2/02_ml_models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Modelos de Machine Learning</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/pt/part2/03_panel_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Dados em painel (multi-series)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/pt/part2/04_hierarchical_forecasting.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Forecasting Hierárquico</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/pt/part2/05_deep_learning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Modelos de deep learning e zero-shot forecasting</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Part III: Apêndices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/pt/extra/sktime_custom.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Criando modelos customizados com sktime</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#carregando-dados" id="toc-carregando-dados" class="nav-link active" data-scroll-target="#carregando-dados"><span class="header-section-number">9.1</span> Carregando dados</a></li>
  <li><a href="#uso-de-pandas-e-dados-hierárquicos" id="toc-uso-de-pandas-e-dados-hierárquicos" class="nav-link" data-scroll-target="#uso-de-pandas-e-dados-hierárquicos"><span class="header-section-number">9.2</span> Uso de pandas e dados hierárquicos</a></li>
  <li><a href="#previsão-sem-reconciliação" id="toc-previsão-sem-reconciliação" class="nav-link" data-scroll-target="#previsão-sem-reconciliação"><span class="header-section-number">9.3</span> Previsão sem reconciliação</a></li>
  <li><a href="#reconciliação-de-previsões-hierárquicas" id="toc-reconciliação-de-previsões-hierárquicas" class="nav-link" data-scroll-target="#reconciliação-de-previsões-hierárquicas"><span class="header-section-number">9.4</span> Reconciliação de previsões hierárquicas</a></li>
  <li><a href="#bottom-up" id="toc-bottom-up" class="nav-link" data-scroll-target="#bottom-up"><span class="header-section-number">9.5</span> Bottom-up</a></li>
  <li><a href="#top-down-forecast-proportions" id="toc-top-down-forecast-proportions" class="nav-link" data-scroll-target="#top-down-forecast-proportions"><span class="header-section-number">9.6</span> Top-down (forecast proportions)</a></li>
  <li><a href="#reconciliação-ótima" id="toc-reconciliação-ótima" class="nav-link" data-scroll-target="#reconciliação-ótima"><span class="header-section-number">9.7</span> Reconciliação ótima</a></li>
  <li><a href="#comparando-resultados" id="toc-comparando-resultados" class="nav-link" data-scroll-target="#comparando-resultados"><span class="header-section-number">9.8</span> Comparando resultados</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../../content/pt/part2/01_exog_variables.html">Part II: Intermediário</a></li><li class="breadcrumb-item"><a href="../../../content/pt/part2/04_hierarchical_forecasting.html"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Forecasting Hierárquico</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Forecasting Hierárquico</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Muitas vezes, não apenas temos múltiplas séries temporais, mas essas séries também estão organizadas em uma hierarquia. Por exemplo, vendas de produtos podem ser organizadas por SKU, categoria, departamento e total da loja.</p>
<p>Vamos usar o mesmo dataset sintético, mas agora com uma hierarquia de produtos.</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">graph TD
  root["__total"]

  %% group -1
  root --&gt; g_minus1["-1"]
  g_minus1 --&gt; sku20["20"]
  g_minus1 --&gt; sku21["21"]
  g_minus1 --&gt; sku22["22"]
  g_minus1 --&gt; sku23["23"]
  g_minus1 --&gt; sku24["24"]

  %% group 0
  root --&gt; g0["0"]
  g0 --&gt; sku0["0"]
  g0 --&gt; sku1["1"]
  g0 --&gt; sku2["2"]
  g0 --&gt; sku3["3"]
  g0 --&gt; sku4["4"]

  %% group 1
  root --&gt; g1["..."]

  
  %% group 3
  root --&gt; g3["3"]
  g3 --&gt; sku15["15"]
  g3 --&gt; sku16["16"]
  g3 --&gt; sku17["17"]
  g3 --&gt; sku18["18"]
  g3 --&gt; sku19["19"]
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p>Ao mesmo tempo que dados hierarárquicos são interessantes pois nos trazem mais informação, eles também trazem desafios adicionais. Imagine que queremos prever as vendas futuras de cada produto. Se fizermos previsões independetes para cada produto, não há garantia que a soma das previsões dos produtos será igual à previsão do total da loja. Isso é chamado de incoerência nas previsões hierárquicas. O processo de ajustar as previsões para garantir coerência é chamado de <strong>reconciliação</strong>.</p>
<section id="carregando-dados" class="level2" data-number="9.1">
<h2 data-number="9.1" class="anchored" data-anchor-id="carregando-dados"><span class="header-section-number">9.1</span> Carregando dados</h2>
<p>Vamos usar os dados sintéticos, agora com sua versao hierárquica.</p>
<div id="32268fc4" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tsbook.datasets.retail <span class="im">import</span> SyntheticRetail</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>dataset <span class="op">=</span> SyntheticRetail(<span class="st">"hierarchical"</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>y_train, X_train, y_test, X_test <span class="op">=</span> dataset.load(<span class="st">"y_train"</span>, <span class="st">"X_train"</span>, <span class="st">"y_test"</span>, <span class="st">"X_test"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="uso-de-pandas-e-dados-hierárquicos" class="level2" data-number="9.2">
<h2 data-number="9.2" class="anchored" data-anchor-id="uso-de-pandas-e-dados-hierárquicos"><span class="header-section-number">9.2</span> Uso de pandas e dados hierárquicos</h2>
<p>Agora, os dataframes possuem mais de 2 ou mais índices, representando a hierarquia.</p>
<div id="6ead52f7" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>y_train</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">sales</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">group_id</th>
<th data-quarto-table-cell-role="th">sku_id</th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th rowspan="5" data-quarto-table-cell-role="th" data-valign="top">-1</th>
<th rowspan="5" data-quarto-table-cell-role="th" data-valign="top">20</th>
<th data-quarto-table-cell-role="th">2020-01-01</th>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2020-01-02</th>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2020-01-03</th>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2020-01-04</th>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2020-01-05</th>
<td>2</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">...</th>
<td>...</td>
</tr>
<tr class="odd">
<th rowspan="5" data-quarto-table-cell-role="th" data-valign="top">__total</th>
<th rowspan="5" data-quarto-table-cell-role="th" data-valign="top">__total</th>
<th data-quarto-table-cell-role="th">2024-07-01</th>
<td>2002</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2024-07-02</th>
<td>1617</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2024-07-03</th>
<td>1917</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2024-07-04</th>
<td>2383</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2024-07-05</th>
<td>2463</td>
</tr>
</tbody>
</table>

<p>51088 rows × 1 columns</p>
</div>
</div>
</div>
<p>Para obter o número de pontos de série únicos (séries temporais individuais), podemos fazer o seguinte:</p>
<div id="2d947a57" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>y_train.index.droplevel(<span class="op">-</span><span class="dv">1</span>).nunique()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>31</code></pre>
</div>
</div>
<p>Note que existem algumas séries com um identificador <code>__total</code>. Esse identificador representa o total para aquele nível da hierarquia. Por exemplo, se o id completo é <code>(-1, "__total")</code>, isso representa o total do grupo -1.</p>
<div id="c686518c" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>y_train.loc[(<span class="op">-</span><span class="dv">1</span>, <span class="st">"__total"</span>)].head()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">sales</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2020-01-01</th>
<td>4</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2020-01-02</th>
<td>2</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2020-01-03</th>
<td>3</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2020-01-04</th>
<td>14</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2020-01-05</th>
<td>16</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>O total de todas as séries é representado por <code>("__total", "__total")</code>.</p>
<div id="57b941c7" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>y_train.loc[(<span class="st">"__total"</span>, <span class="st">"__total"</span>)]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">sales</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2020-01-01</th>
<td>24</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2020-01-02</th>
<td>19</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2020-01-03</th>
<td>14</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2020-01-04</th>
<td>23</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2020-01-05</th>
<td>23</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">...</th>
<td>...</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2024-07-01</th>
<td>2002</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2024-07-02</th>
<td>1617</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2024-07-03</th>
<td>1917</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2024-07-04</th>
<td>2383</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2024-07-05</th>
<td>2463</td>
</tr>
</tbody>
</table>

<p>1648 rows × 1 columns</p>
</div>
</div>
</div>
<p>Para contabilizar o número de séries temporais individuais, podemos fazer o seguinte:</p>
<div id="49dda348" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>y_train.index.droplevel(<span class="op">-</span><span class="dv">1</span>).nunique()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>31</code></pre>
</div>
</div>
</section>
<section id="previsão-sem-reconciliação" class="level2" data-number="9.3">
<h2 data-number="9.3" class="anchored" data-anchor-id="previsão-sem-reconciliação"><span class="header-section-number">9.3</span> Previsão sem reconciliação</h2>
<p>Vamos fazer uma previsão e entender o problema da incoerência.</p>
<div id="7702f0d6" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>fh <span class="op">=</span> y_test.index.get_level_values(<span class="op">-</span><span class="dv">1</span>).unique()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="a91f2ab8" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tsbook.forecasting.reduction <span class="im">import</span> ReductionForecaster</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lightgbm <span class="im">import</span> LGBMRegressor</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>forecaster <span class="op">=</span> ReductionForecaster(</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    LGBMRegressor(n_estimators<span class="op">=</span><span class="dv">100</span>, verbose<span class="op">=-</span><span class="dv">1</span>, objective<span class="op">=</span><span class="st">"tweedie"</span>, random_state<span class="op">=</span><span class="dv">42</span>),</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    window_length<span class="op">=</span><span class="dv">30</span>,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    normalization_strategy<span class="op">=</span><span class="st">"divide_mean"</span>,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>forecaster.fit(y_train, X<span class="op">=</span>X_train)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> forecaster.predict(fh, X<span class="op">=</span>X_test)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Para somar as previsões de baixo para cima, podemos usar o transformador <code>Aggregator</code>. Vamos ver que, quando somarmos as previsões das séries filhas, o resultado não é igual à previsão da série total.</p>
<div id="58199692" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sktime.transformations.hierarchical.aggregate <span class="im">import</span> Aggregator</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>Aggregator().fit_transform(y_pred) <span class="op">-</span> y_pred</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">sales</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">group_id</th>
<th data-quarto-table-cell-role="th">sku_id</th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th rowspan="5" data-quarto-table-cell-role="th" data-valign="top">-1</th>
<th rowspan="5" data-quarto-table-cell-role="th" data-valign="top">20</th>
<th data-quarto-table-cell-role="th">2024-07-06</th>
<td>0.000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2024-07-07</th>
<td>0.000000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2024-07-08</th>
<td>0.000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2024-07-09</th>
<td>0.000000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2024-07-10</th>
<td>0.000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">...</th>
<td>...</td>
</tr>
<tr class="odd">
<th rowspan="5" data-quarto-table-cell-role="th" data-valign="top">__total</th>
<th rowspan="5" data-quarto-table-cell-role="th" data-valign="top">__total</th>
<th data-quarto-table-cell-role="th">2024-12-28</th>
<td>-303.956496</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2024-12-29</th>
<td>276.995900</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2024-12-30</th>
<td>-189.336243</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2024-12-31</th>
<td>415.699469</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-01-01</th>
<td>-148.407308</td>
</tr>
</tbody>
</table>

<p>5580 rows × 1 columns</p>
</div>
</div>
</div>
<p>Existe uma diferença… ou seja, os valores não batem. Imagine o impacto de levar previsões incoerentes para a tomada de decisão em uma empresa? A raiz do problema é que temos mais modelos que graus de liberdade. Para ilustrar, suponha que temos 3 séries: <span class="math inline">\(A\)</span>, <span class="math inline">\(B\)</span> e <span class="math inline">\(C\)</span>, onde:</p>
<p><span class="math display">\[
C(t) = A(t) + B(t)
\]</span></p>
<p>Aqui, temos 3 séries, mas apenas 2 graus de liberdade, pois <span class="math inline">\(C\)</span> é completamente determinado por <span class="math inline">\(A\)</span> e <span class="math inline">\(B\)</span>. Se fizermos previsões independentes para <span class="math inline">\(A\)</span>, <span class="math inline">\(B\)</span> e <span class="math inline">\(C\)</span>, não há garantia de que a relação acima será mantida nas previsões.</p>
</section>
<section id="reconciliação-de-previsões-hierárquicas" class="level2" data-number="9.4">
<h2 data-number="9.4" class="anchored" data-anchor-id="reconciliação-de-previsões-hierárquicas"><span class="header-section-number">9.4</span> Reconciliação de previsões hierárquicas</h2>
<p><img src="img/hierarchical_reconciled_vs_not.png" class="img-fluid"></p>
<p>Existem diferentes métodos para reconciliar previsões em séries temporais hierárquicas. Não existe uma solução única, e o melhor método depende dos dados e do contexto.</p>
</section>
<section id="bottom-up" class="level2" data-number="9.5">
<h2 data-number="9.5" class="anchored" data-anchor-id="bottom-up"><span class="header-section-number">9.5</span> Bottom-up</h2>
<p>A maneira mais simples de reconcialiar previsões hierárquicas é a abordagem <strong>bottom-up</strong>. Nessa abordagem, fazemos previsões apenas para as séries mais baixas na hierarquia (as séries filhas) e depois somamos essas previsões para obter as previsões das séries superiores (as séries pais).</p>
<p><img src="img/hierarchical_bottomup.png" alt="Hierarchical Bottom-up" width="450"></p>
<p>Lados positivos:</p>
<ul>
<li>Simplicidade: fácil de entender e implementar.</li>
<li>Coerência garantida: a soma das previsões das séries filhas sempre será igual à previsão da série pai.</li>
<li>Sérias filhas podem capturar detalhes específicos que podem ser perdidos em níveis superiores.</li>
</ul>
<p>No entanto, essa abordagem também tem desvantagens: é sucetível ao ruído nas séries filhas, e se as séries filhas tiverem pouca informação, as previsões podem ser ruins. Por exemplo, muitos zeros nas séries de níveis baixos pode levar a previsões ruins a niveis agregados.</p>
<div id="2f151106" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sktime.transformations.hierarchical.reconcile <span class="im">import</span> BottomUpReconciler</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>bottom_up <span class="op">=</span> BottomUpReconciler() <span class="op">*</span> forecaster</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>bottom_up.fit(y_train)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>y_pred_bottomup <span class="op">=</span> bottom_up.predict(fh<span class="op">=</span>fh)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Agora vemos que as previsões são coerentes:</p>
<div id="a22a1a1c" class="cell" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>Aggregator().fit_transform(y_pred_bottomup) <span class="op">-</span> y_pred_bottomup</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">sales</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">group_id</th>
<th data-quarto-table-cell-role="th">sku_id</th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th rowspan="5" data-quarto-table-cell-role="th" data-valign="top">-1</th>
<th rowspan="5" data-quarto-table-cell-role="th" data-valign="top">20</th>
<th data-quarto-table-cell-role="th">2024-07-06</th>
<td>0.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2024-07-07</th>
<td>0.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2024-07-08</th>
<td>0.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2024-07-09</th>
<td>0.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2024-07-10</th>
<td>0.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">...</th>
<td>...</td>
</tr>
<tr class="odd">
<th rowspan="5" data-quarto-table-cell-role="th" data-valign="top">__total</th>
<th rowspan="5" data-quarto-table-cell-role="th" data-valign="top">__total</th>
<th data-quarto-table-cell-role="th">2024-12-28</th>
<td>0.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2024-12-29</th>
<td>0.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2024-12-30</th>
<td>0.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2024-12-31</th>
<td>0.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-01-01</th>
<td>0.0</td>
</tr>
</tbody>
</table>

<p>5580 rows × 1 columns</p>
</div>
</div>
</div>
</section>
<section id="top-down-forecast-proportions" class="level2" data-number="9.6">
<h2 data-number="9.6" class="anchored" data-anchor-id="top-down-forecast-proportions"><span class="header-section-number">9.6</span> Top-down (forecast proportions)</h2>
<p>Outra abordagem é a <strong>top-down</strong>. Nessa abordagem, fazemos previsões apenas para as séries superiores na hierarquia (as séries pais) e depois distribuímos essas previsões para as séries filhas com base em proporções previstas.</p>
<p>Suponha que temos a seguinte hierarquia <span class="math inline">\(C(t) = A(t) + B(t)\)</span>. Considere <span class="math inline">\(\hat{C}(t)\)</span>, <span class="math inline">\(\hat{A}(t)\)</span> e <span class="math inline">\(\hat{B}(t)\)</span> como as previsões para <span class="math inline">\(C\)</span>, <span class="math inline">\(A\)</span> e <span class="math inline">\(B\)</span>, respectivamente. Na abordagem top-down, faríamos o seguinte:</p>
<ol type="1">
<li>Prever <span class="math inline">\(\hat{C}(t)\)</span>, <span class="math inline">\(\hat{A}(t)\)</span> e <span class="math inline">\(\hat{B}(t)\)</span> independentemente.</li>
<li>Calcular as proporções previstas para os níveis mais baixos: <span class="math display">\[
p_A(t) = \frac{\hat{A}(t)}{\hat{A}(t) + \hat{B}(t)}
\]</span></li>
</ol>
<p><span class="math display">\[
p_B(t) = \frac{\hat{B}(t)}{\hat{A}(t) + \hat{B}(t)}
\]</span></p>
<ol start="3" type="1">
<li>Distribuir a previsão de <span class="math inline">\(C\)</span> para <span class="math inline">\(A\)</span> e <span class="math inline">\(B\)</span> usando essas proporções: <span class="math display">\[
\tilde{A}(t) = p_A(t) \cdot \hat{C}(t)
\]</span></li>
</ol>
<p><span class="math display">\[
\tilde{B}(t) = p_B(t) \cdot \hat{C}(t)
\]</span></p>
<p>Essa abordagem é capaz de usufruir da qualidade do forecast total, e ainda consegue distribuir para as séries filhas baseadas no histórico.</p>
<p><img src="img/hierarchical_td_fcst.png" alt="Topdown Forecast" width="900"></p>
<p>O que chamam de “Proporções históricas” é equivalente a esse método, mas com um modelo Naive para prever as proporções.</p>
<p>Esse método pode ser bom quando o forecast total é de boa qualidade. No entanto, dependemos profundamente da qualidade do forecast total e das proporções.</p>
<div id="b6d8565a" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sktime.transformations.hierarchical.reconcile <span class="im">import</span> TopdownReconciler</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>top_down_fcst <span class="op">=</span> TopdownReconciler() <span class="op">*</span> forecaster</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>top_down_fcst.fit(y_train)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>y_pred_topdown <span class="op">=</span> top_down_fcst.predict(fh<span class="op">=</span>fh)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="reconciliação-ótima" class="level2" data-number="9.7">
<h2 data-number="9.7" class="anchored" data-anchor-id="reconciliação-ótima"><span class="header-section-number">9.7</span> Reconciliação ótima</h2>
<p>Existe uma abordagem mais sofisticada, com uma intuição geométrica interessante. A ideia é ajustar as previsões iniciais para que elas satisfaçam as restrições de soma da hierarquia. Por exemplo, para a hierarquia <span class="math inline">\(C(t) = A(t) + B(t)\)</span>, queremos garantir que:</p>
<p><span class="math display">\[
\hat{C}(t) = \hat{A}(t) + \hat{B}(t)
\]</span></p>
<p>Se consideramos nosso espaço 3D de observações <span class="math inline">\((\hat{A}, \hat{B}, \hat{C})\)</span>, a condição acima é satisfeita para um plano 2D nesse universo.</p>
<p><img src="img/coherent_plane.png" class="img-fluid"></p>
<p>Podemos então projetar nossas previsões iniciais nesse plano para obter previsões coerentes. Essa projeção pode ser feita de várias maneiras, levando a diferentes métodos de reconciliação ótima. Os métodos levam o nome “OLS” pois a projeção é feita minimizando o erro quadrático (Ordinary Least Squares).</p>
<ul>
<li><strong>OLS</strong> : projetar ortogonalmente todas as previsões base na espaço de reconciliação, tratando todas as séries igualmente.</li>
<li><strong>Weighted OLS</strong>: projetar obliquamente, ou seja, considerando pesos diferentes para cada série, permitindo dar mais importância a certas séries na reconciliação. A projeção não faz mais uma perpendicular, mas sim uma oblíqua.</li>
<li><strong>Minimum trace (MinT)</strong>: use a matriz de covariância do erro para encontrar as previsões reconciliadas ótimas. Chamado de “ótimo”.</li>
</ul>
<p>Para a reconciliação ótima com OLS, podemos usar o <code>OptimalReconciler</code> do sktime:</p>
<div id="1dc629c1" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sktime.transformations.hierarchical.reconcile <span class="im">import</span> OptimalReconciler</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>optimal <span class="op">=</span> OptimalReconciler(<span class="st">"ols"</span>) <span class="op">*</span> forecaster</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>optimal.fit(y_train)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>y_pred_optimal <span class="op">=</span> optimal.predict(fh<span class="op">=</span>fh)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="c360e66d" class="cell" data-execution_count="15">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sktime.utils.plotting <span class="im">import</span> plot_series</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>idx <span class="op">=</span> y_train.index.droplevel(<span class="op">-</span><span class="dv">1</span>).unique()[<span class="dv">10</span>]</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>plot_series(</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    y_train.loc[idx,],</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    y_test.loc[idx,],</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    y_pred.loc[idx,],</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    y_pred_optimal.loc[idx,],</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    labels<span class="op">=</span>[<span class="st">"Train"</span>, <span class="st">"Test"</span>, <span class="st">"Predicted (sem reconciliação)"</span>, <span class="st">"Predicted (ótimo)"</span>],</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>plt.xlim(pd.to_datetime(<span class="st">"2024-05-01"</span>), <span class="va">None</span>)</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="04_hierarchical_forecasting_files/figure-html/cell-16-output-1.png" width="1286" height="337" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Para reconciliações ótimas (que usam a covariância do erro), podemos usar o <code>ReconcilerForecaster</code> do sktime, que internamente já faz o cálculo da covariância do erro:</p>
<div id="f80f4d0e" class="cell" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sktime.forecasting.reconcile <span class="im">import</span> ReconcilerForecaster</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>mint_forecaster <span class="op">=</span> ReconcilerForecaster(</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    forecaster<span class="op">=</span>forecaster,</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span><span class="st">"mint_shrink"</span>)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>mint_forecaster.fit(y_train)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>y_pred_mint <span class="op">=</span> mint_forecaster.predict(fh<span class="op">=</span>fh)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="comparando-resultados" class="level2" data-number="9.8">
<h2 data-number="9.8" class="anchored" data-anchor-id="comparando-resultados"><span class="header-section-number">9.8</span> Comparando resultados</h2>
<div id="440bc30f" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sktime.performance_metrics.forecasting <span class="im">import</span> MeanSquaredScaledError</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>metric <span class="op">=</span> MeanSquaredScaledError(multilevel<span class="op">=</span><span class="st">"uniform_average_time"</span>)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>pd.DataFrame(</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Baseline"</span>: metric(y_test, y_pred, y_train<span class="op">=</span>y_train),</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"BottomUpReconciler"</span>: metric(y_test, y_pred_bottomup, y_train<span class="op">=</span>y_train),</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"TopDownReconciler"</span>: metric(y_test, y_pred_topdown, y_train<span class="op">=</span>y_train),</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"OptimalReconciler (ols)"</span>: metric(y_test, y_pred_optimal, y_train<span class="op">=</span>y_train),</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Mint Reconciler"</span>: metric(y_test, y_pred_mint, y_train<span class="op">=</span>y_train),</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span>[<span class="st">"Mean Absolute Squared Error"</span>],</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Baseline</th>
<th data-quarto-table-cell-role="th">BottomUpReconciler</th>
<th data-quarto-table-cell-role="th">TopDownReconciler</th>
<th data-quarto-table-cell-role="th">OptimalReconciler (ols)</th>
<th data-quarto-table-cell-role="th">Mint Reconciler</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">Mean Absolute Squared Error</th>
<td>76.656003</td>
<td>22.363895</td>
<td>96.793563</td>
<td>95.197245</td>
<td>95.599564</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../../content/pt/part2/03_panel_data.html" class="pagination-link" aria-label="Dados em painel (multi-series)">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Dados em painel (multi-series)</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../../content/pt/part2/05_deep_learning.html" class="pagination-link" aria-label="Modelos de deep learning e zero-shot forecasting">
        <span class="nav-page-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Modelos de deep learning e zero-shot forecasting</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>